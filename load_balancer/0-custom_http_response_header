#!/usr/bin/env bash
#!/usr/bin/env bash
# Configure Nginx to include a custom HTTP header with the server hostname
# Ignore SC2154 for shellcheck
set -e

# Update package list and install Nginx if not installed
apt-get update -y
apt-get install -y nginx

# Ensure /var/www/html exists
mkdir -p /var/www/html

# Add default index page
echo "Holberton School" > /var/www/html/index.html

# Start or reload Nginx without systemctl
service nginx start 2>/dev/null || service nginx restart

# Nginx default config file
NGINX_CONF="/etc/nginx/sites-available/default"

# Backup config if not already done
[ ! -f "${NGINX_CONF}.bak" ] && cp "$NGINX_CONF" "${NGINX_CONF}.bak"

# Add X-Served-By header inside the server block
# It will dynamically use the hostname
awk -v host="$(hostname)" '
/server\s*{/ && !x {
    print
    print "    add_header X-Served-By \"" host "\";"
    x=1
    next
}
{print}
' "$NGINX_CONF" > "${NGINX_CONF}.tmp" && mv "${NGINX_CONF}.tmp" "$NGINX_CONF"

# Test configuration
nginx -t

# Reload Nginx
nginx -s reload
