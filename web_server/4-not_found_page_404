#!/usr/bin/env bash
#install and configure Nginx on a new Ubuntu server
# and set up a custom 404 page with the string "Ceci n'est pas une page"

set -e

# Update package list and install Nginx
apt-get update -y
apt-get install -y nginx

# Replace default homepage
echo "Holberton School" > /var/www/html/index.html

# Create custom 404 page
echo "Ceci n'est pas une page" > /var/www/html/custom_404.html

# Start or restart Nginx
service nginx start || service nginx restart

# Nginx default config file
NGINX_CONF="/etc/nginx/sites-available/default"

# Backup config if not already done
if [ ! -f "${NGINX_CONF}.bak" ]; then
    cp "$NGINX_CONF" "${NGINX_CONF}.bak"
fi

# Remove any previous custom 404 or redirect blocks
sed -i "/error_page 404/d" "$NGINX_CONF"
sed -i "/location = \/custom_404.html/,/}/d" "$NGINX_CONF"

# Insert custom 404 directives inside the server block
awk '
/server\s*{/ {
    print
    print "    # Custom 404 page"
    print "    error_page 404 /custom_404.html;"
    print "    location = /custom_404.html {"
    print "        root /var/www/html;"
    print "        internal;"
    print "    }"
    next
}
{print}
' "$NGINX_CONF" > "${NGINX_CONF}.tmp" && mv "${NGINX_CONF}.tmp" "$NGINX_CONF"

# Test Nginx configuration
nginx -t

# Reload Nginx to apply changes
nginx -s reload
