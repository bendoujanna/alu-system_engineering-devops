#!/usr/bin/env bash
#install and configure Nginx on a new Ubuntu server
# and set up a custom 404 page with the string "Ceci n'est pas une page"
set -e

# Update package list and install Nginx
apt-get update -y
apt-get install -y nginx

# Replace default index page content
echo "Holberton School" > /var/www/html/index.html

# Start or restart Nginx
service nginx start || service nginx restart

# Nginx config file path
NGINX_CONF="/etc/nginx/sites-available/default"

# Backup config if not already done
if [ ! -f "${NGINX_CONF}.bak" ]; then
    cp "$NGINX_CONF" "${NGINX_CONF}.bak"
fi

# Create a custom 404 page
echo "Ceci n'est pas une page" > /var/www/html/404.html

# Remove any existing error_page directives for 404
sed -i "/error_page 404/d" "$NGINX_CONF"

# Insert error_page directive inside server block
awk '
/server\s*{/ {
    print
    print "    error_page 404 /404.html;"
    next
}
{print}
' "$NGINX_CONF" > "${NGINX_CONF}.tmp" && mv "${NGINX_CONF}.tmp" "$NGINX_CONF"

# Test Nginx configuration
nginx -t

# Reload Nginx to apply changes
nginx -s reload
