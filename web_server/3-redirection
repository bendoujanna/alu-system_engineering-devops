#!/usr/bin/env bash
# Install and configure Nginx on a new Ubuntu server
# and add a 301 redirect for /redirect_me
set -e

# Update package list and install Nginx
apt-get update -y
apt-get install -y nginx

# Replace default page with our content
echo "Holberton School" > /var/www/html/index.html

# Start or restart Nginx
service nginx start || service nginx restart

# Default Nginx config
NGINX_CONF="/etc/nginx/sites-available/default"

# Backup config if not already done
if [ ! -f "${NGINX_CONF}.bak" ]; then
    cp "$NGINX_CONF" "${NGINX_CONF}.bak"
fi

# Remove any existing /redirect_me block
sed -i "/location \/redirect_me/,/}/d" "$NGINX_CONF"

# Insert /redirect_me exact match inside server block, right after 'server {'
awk '
/server\s*{/ {
    print
    print "    location = /redirect_me { return 301 https://www.youtube.com/watch?v=QH2-TGUlwu4; }"
    print "    location = /redirect_me/ { return 301 https://www.youtube.com/watch?v=QH2-TGUlwu4; }"
    next
}
{print}
' "$NGINX_CONF" > "${NGINX_CONF}.tmp" && mv "${NGINX_CONF}.tmp" "$NGINX_CONF"

# Test syntax
nginx -t
# Reload Nginx to apply changes
nginx -s reload
